name: ç”µé‡ç›‘æ§

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 * * * *'
    # æ¯å‘¨æ—¥ 00:00 UTC è¿è¡ŒæŠ¥å‘Š
    - cron: '0 0 * * 0'
  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  
  push:
    branches:
      - main
    paths:
      - '.github/workflows/monitor.yml'

permissions:
  contents: write  # å…è®¸æäº¤æ•°æ®

concurrency:
  group: monitor-data
  cancel-in-progress: false

jobs:
  monitor:
    name: è·å–å¹¶å­˜å‚¨ç”µé‡æ•°æ®
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: é…ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "API__SYSID=${{ secrets.API__SYSID }}" >> $GITHUB_ENV
          echo "API__ROOMID=${{ secrets.API__ROOMID }}" >> $GITHUB_ENV
          echo "API__AREAID=${{ secrets.API__AREAID }}" >> $GITHUB_ENV
          echo "API__BUILDID=${{ secrets.API__BUILDID }}" >> $GITHUB_ENV
          echo "APP__LOG_LEVEL=INFO" >> $GITHUB_ENV
          
          # é‚®ä»¶é…ç½®ï¼ˆå¯é€‰ï¼‰
          if [ -n "${{ secrets.NOTIFICATION__SMTP_HOST }}" ]; then
            echo "NOTIFICATION__SMTP_HOST=${{ secrets.NOTIFICATION__SMTP_HOST }}" >> $GITHUB_ENV
            echo "NOTIFICATION__SMTP_PORT=${{ secrets.NOTIFICATION__SMTP_PORT }}" >> $GITHUB_ENV
            echo "NOTIFICATION__SMTP_STARTTLS=${{ secrets.NOTIFICATION__SMTP_STARTTLS }}" >> $GITHUB_ENV
            echo "NOTIFICATION__SMTP_USER=${{ secrets.NOTIFICATION__SMTP_USER }}" >> $GITHUB_ENV
            echo "NOTIFICATION__SMTP_PASSWORD=${{ secrets.NOTIFICATION__SMTP_PASSWORD }}" >> $GITHUB_ENV
            echo "NOTIFICATION__RECIPIENTS=${{ secrets.NOTIFICATION__RECIPIENTS }}" >> $GITHUB_ENV
          fi
      
      - name: è·å–ç”µé‡æ•°æ®
        id: fetch
        run: |
          emon fetch --verbose
          
          # è¯»å–æœ€æ–°ç”µé‡å€¼
          LATEST_POWER=$(tail -n 1 data/electricity.csv | cut -d',' -f2)
          echo "latest_power=$LATEST_POWER" >> $GITHUB_OUTPUT
      
      - name: æ£€æŸ¥å‘Šè­¦
        if: success()
        run: |
          emon alert --threshold 30
      
      - name: æäº¤æ•°æ®
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase
          git add data/electricity.csv
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°æ•°æ®éœ€è¦æäº¤"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            POWER="${{ steps.fetch.outputs.latest_power }}"
            git commit -m "ğŸ“Š æ•°æ®æ›´æ–°: ${POWER} åº¦ @ ${TIMESTAMP}"
            git push
          fi
      
      - name: ä¸Šä¼ é”™è¯¯æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: data/logs/
          retention-days: 7
  
  report:
    name: ç”Ÿæˆæ¯å‘¨æŠ¥å‘Š
    runs-on: ubuntu-latest
    
    # æ¯å‘¨æ—¥ 00:00 UTC è¿è¡Œ
    if: github.event.schedule == '0 0 * * 0' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[web]"
      
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          emon report --days 7 --no-open --output weekly_report.html
      
      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output/reports
          publish_branch: gh-pages
          keep_files: true
      
      - name: ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report
          path: output/reports/weekly_report.html
          retention-days: 30
